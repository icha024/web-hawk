<!DOCTYPE html>
<html lang="en-US">
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
<script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.4.4/angular.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.4.4/angular-resource.js"></script>
<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
<style>
.body-bg {
    background-color: #f2f2f2;
    font-family: 'sans-serif'
}
.title {
    color: white
}
.navbar-default {
  background-color: #205081;
  border-color: #205081;
}
.panel-success>.panel-heading {
    background-color:#14892c;
    color: white;
}
</style>
<body class="body-bg">
    <div ng-app="myApp" ng-controller="myCtrl">
            <nav class="navbar navbar-static-top navbar-default">
		        <div class="container-fluid"><h2 class="title"></i>Web Hawk</h2></div>
            </nav>
        <div class="container">
            <div class="panel panel-default">
            <div class="panel-body">

            <div class="row clearfix">
                <div class="col-md-12 column">
                    <div class="panel panel-success">
                        <div class="panel-heading clearfix">
                            <span class="pull-left">
                                <h3 class="panel-title" ng-if="good">
                                    All Systems Operational
                                </h3>
                                <h3 class="panel-title" ng-if="!good">
                                    Not All Systems Operational
                                </h3>
                            </span>
                            <span class="pull-right">
                                <p>@ {{ updated }}</p>
                            </span>
                        </div>                
                    </div>

                    <div class="row">
                        <div class="col-md-12 column">
                            <div class="list-group">

                                <div class="list-group-item clearfix" ng-repeat="eachData in services">
                                        <span class="pull-left clearfix">
                                            <h4>
                                                {{ eachData.Name }}
                                            </h4>
                                            <h6><i>{{ eachData.Url }}</i></h6>
                                        </span>
                                        
                                        <span class="pull-right clearfix">
                                            <span class="label label-danger" ng-if="!eachData.Alive">Not Operational</span>
                                            <span class="label label-success" ng-if="eachData.Alive">Operational</span>
                                            <br/><i>{{ eachData.Msec.toFixed(2) }} ms </i>
                                        </span>
                                </div>

                            </div>
                        </div>
                    </div>

                </div>
            </div>

        </div>
        </div>

        </div>
    </div>
    <script>
var app = angular.module("myApp", ["ngResource"]) 
app.factory('myService', ['$resource', function($resource) {
    return $resource("http://localhost:3001/up")
  }])
app.controller("myCtrl", function(myService, $scope, $http) {
    $scope.services = []
    $scope.good = true
    $scope.updated = ""	
    myService.get(function(res) {
        setStatus(res)
    }, function(error) {
        // Error handler code
    });

    function setStatus(data){
        $scope.updated = data.Timestamp
        $scope.services = data.Services
        data.Services.forEach(function(eachSvc){
            $scope.good = $scope.good & eachSvc.Alive
        })
        // console.debug("status updated: " + JSON.stringify(data))
    }

    var socket = io('http://localhost:3001/socket.io');
    socket.on('updateEvent', function (data) {
        console.log(data);
        $scope.$apply(setStatus(JSON.parse(data)))
        // socket.emit('my other event', { my: 'data' });
    });
})
</script>
</body>

</html>